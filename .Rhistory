tab_header(glue("{conf_label} Men's Basketball Table | End of Regular Season"),
"Data current through the end of the regular season w/ an EPL table spin") %>%
tab_source_note(md('Data by cbbdata + cbbplotR through March 11<br>Table by @andreweatherman')) %>%
cols_label(
team = 'Team + Seed',
ov_record = 'Overall',
conf_record = 'Conf.',
adj_em = 'Adj. EM',
kp_adj_o = 'Adj. Off',
kp_adj_d = 'Adj. Def',
pts_for = 'PF',
pts_against = 'PA',
diff = 'PD',
opp_logo = 'Next',
results = 'Form'
)
return(table)
}
table <- plot_pl_standings('Amer', 'aac', 'American')
gt_theme_pl <- function(gt_object, ...) {
table_id <- subset(gt_object[['_options']], parameter == 'table_id')$value[[1]]
if (is.na(table_id)) {
table_id <- gt::random_id()
opt_position <- which("table_id" %in% gt_object[["_options"]][["parameter"]])[[1]]
gt_object[["_options"]][["value"]][[opt_position]] <- table_id
}
gt_object %>%
gt::tab_style(
locations = gt::cells_body(
columns = gt::everything()
),
style = gt::cell_text(
font = gt::google_font('DM Sans'),
color = '#37003c',
size = px(14)
)
) %>%
gt::tab_style(
locations = gt::cells_column_labels(
columns = gt::everything()
),
style = gt::cell_text(
font = gt::google_font('DM Sans'),
color = '#87668a',
weight = 650,
size = px(12),
transform = 'capitalize'
)
) %>%
gt::tab_style(
locations = gt::cells_title('title'),
style = gt::cell_text(
font = gt::google_font('DM Sans'),
weight = 650
)
) %>%
gt::tab_style(
locations = gt::cells_title('subtitle'),
style = gt::cell_text(
font = gt::google_font('DM Sans'),
weight = 500
)
) %>%
gt::tab_style(
locations = gt::cells_source_notes(),
style = gt::cell_text(
font = gt::google_font('DM Sans'),
)
) %>%
gt::tab_options(
heading.align = "left",
column_labels.border.top.style = "none",
table.border.top.style = "none",
table_body.border.top.style = "none",
table_body.border.bottom.color = "white",
heading.border.bottom.style = "none",
data_row.padding = px(3),
column_labels.font.size = px(12),
table.border.bottom.style = "none",
source_notes.font.size = 10,
source_notes.border.lr.style = "none",
column_labels.border.bottom.style = "solid",
column_labels.border.bottom.width = px(1),
column_labels.border.bottom.color = "#37003c",
...
) %>%
gt::opt_css(
paste0("#", table_id,
" .gt_col_heading
{
padding-bottom: 3px;
}",
"#", table_id,
" .gt_heading
{
padding-bottom: 0px;
padding-top: 6px
}",
"#", table_id,
" .gt_subtitle
{
padding-top: 2px;
padding-bottom: 6px;
}",
"#", table_id,
" .gt_sourcenote
{
line-height: 1.2
}"),
add = TRUE
)
}
table <- plot_pl_standings('Amer', 'aac', 'American')
gtsave_extra(table, 'amer_pl_table.png', zoom = 5)
crop_gt('amer_pl_table.png', 60)
crop_gt <- function(file, whitespace) {
image_read(file) %>%
image_trim() %>%
image_border("white", glue('{whitespace}x{whitespace}')) %>%
image_write(file)
}
crop_gt('amer_pl_table.png', 60)
plot_pl_standings <- function(conf, nnet_conf, conf_label) {
nonet_current <- function(conf) {
nonet_game_results <- function(conf) {
url <- paste0('https://bball.notnothing.net/schedules/', conf, 'm.xml')
request(url) %>%
req_perform() %>%
resp_body_xml() %>%
xml_find_all(".//allgames") %>%
pluck(1) %>%
xml_find_all(".//game") %>%
#pluck(1) %>%
xml_attrs() %>%
map_dfr(., enframe) %>%
pivot_wider() %>%
unnest() %>%
janitor::clean_names() %>%
mutate(gid = paste0(home, '-', visitor, '-1'),
date = as.Date(date, format = '%Y%m%d'),
result = ifelse(complete == 'Y', ifelse(winner == 'H', 1, 0),
NA)) %>%
mutate(conf = conf) %>%
select(date, gid, result)
}
game_results <- suppressWarnings(nonet_game_results(conf))
to_submit <- game_results %>%
filter(!is.na(result))
md5 <- read_html(paste0("https://bball.notnothing.net/", conf, ".php?sport=mbb")) %>%
html_nodes("input[name='md5']") %>%
html_attr('value')
db <- paste0('schedules%2F', conf, 'm.xml')
fixed_data <- paste0('database=schedules%2F', conf, 'm.xml&isuwins=&verbose=&md5=', md5)
form_data <- to_submit %>%
mutate(gid_result = paste(gid, result, sep="=")) %>%
pull(gid_result) %>%
paste(collapse = "&")
full_post <- paste(form_data, fixed_data, sep="&")
post_nonet <- function(conf) {
team_ids <- cbd_teams() %>% select(tid = nnet_id, matched = common_team,
shortname = nnet_short)
request(paste0('https://bball.notnothing.net/bracket.php?conf=', conf, 'm')) %>%
req_body_raw(full_post, type = "application/x-www-form-urlencoded") %>%
req_perform() %>%
resp_body_html() %>%
html_text() %>%
str_squish() %>%
str_match_all(., "(\\d+)\\.\\s+([^\\(]+)\\s+\\(([^\\)]+)\\)") %>%
pluck(1) %>%
as_tibble() %>%
select(finish = V2, team = V3, record = V4) %>%
mutate(record = gsub(' - ', '-', record),
conf = conf) %>%
left_join(team_ids %>% select(shortname, matched),
join_by('team' == 'shortname')) %>%
select(finish, team = matched, record, conf)
}
data <- post_nonet(conf)
return(data)
}
seeds <- nonet_current(nnet_conf)
conf_data <- cbd_torvik_team_factors(year = 2024, game_type = 'conf') %>%
filter(conf == !!conf)
last_five <- cbd_torvik_game_box(year = 2024, conf = conf) %>%
slice_max(date, n = 5, by = team) %>%
arrange(date) %>%
select(team, result) %>%
mutate(result = ifelse(result == 'W', 1, 0)) %>%
summarize(
results = list(result),
.by = team
)
point_diff <- cbd_torvik_game_box(year = 2024, conf = conf) %>%
filter(type == 'conf') %>%
summarize(
pts_for = sum(pts),
pts_against = sum(opp_pts),
diff = pts_for - pts_against,
.by = team
)
next_opp <- cbd_torvik_team_schedule(year = 2024) %>%
filter(team %in% conf_data$team & date >= Sys.Date()) %>%
slice_min(date, n = 1, by = team) %>%
select(team, opp)
data <- conf_data %>%
left_join(cbd_kenpom_ratings(year=2024) %>% select(adj_em, kp_adj_o = adj_o, kp_adj_d = adj_d, team)) %>%
left_join(
cbd_torvik_game_box(year = 2024, conf = conf) %>%
summarize(ov_record = glue("{sum(result == 'W')}-{sum(result=='L')}"), .by = team)
) %>%
mutate(conf_record = glue('{wins}-{losses}')) %>%
select(team, ov_record, conf_record, adj_em, kp_adj_o, kp_adj_d, adj_em) %>%
left_join(point_diff, by = 'team') %>%
left_join(next_opp, by = 'team') %>%
inner_join(seeds %>% mutate(seed = as.numeric(finish), record = NULL, conf = NULL, finish = NULL), by = 'team') %>%
left_join(last_five, by = 'team') %>%
left_join(cbd_teams() %>% select(team = common_team, team_abbr = espn_abbreviation, logo), by = 'team') %>%
left_join(cbd_teams() %>% select(opp = common_team, opp_logo = logo), by = 'opp') %>%
mutate(opp_logo = ifelse(is.na(opp), 'https://static-00.iconduck.com/assets.00/hourglass-half-icon-1608x2048-ctcr2jce.png', opp_logo),
opp_logo = glue("<img src='{opp_logo}' style='height: 20px; width: auto; vertical-align: middle;'>"),
team = glue("<img src='{logo}' style='height: 20px; width: auto; vertical-align: -30%;'> &nbsp; {seed}. {team_abbr}")
) %>%
arrange(seed)
table <- data %>%
select(-c(team_abbr, logo, seed)) %>%
gt() %>%
cols_hide(opp) %>%
gt_theme_pl() %>%
gt_plt_winloss(results, max_wins = 5, palette = c('#637E6C', '#EF946C', 'white')) %>%
gt_add_divider(conf_record, include_labels = FALSE, weight = px(1), color = '#37003c') %>%
gt_add_divider(kp_adj_d, include_labels = FALSE, weight = px(1), color = '#37003c') %>%
tab_style(locations = cells_body(rows = c(4, 6, 10)), style = cell_borders(sides = 'bottom', color = '#37003c')) %>%
fmt_markdown(c(team, opp_logo)) %>%
fmt_number(pts_for:diff, decimals = 0) %>%
cols_align(column = team, 'left') %>%
cols_align(column = -team, 'center') %>%
tab_spanner(columns = contains('record'), label = 'Records') %>%
tab_spanner(columns = adj_em:kp_adj_d, label = 'KenPom Efficiencies') %>%
tab_style(locations = cells_body(columns = team), cell_text(weight = 'bold')) %>%
tab_header(glue("{conf_label} Men's Basketball Table | End of Regular Season"),
"Data current through the end of the regular season w/ an EPL table spin") %>%
tab_source_note(md('Data by cbbdata + cbbplotR through March 11<br>Table by @andreweatherman')) %>%
cols_label(
team = 'Team + Seed',
ov_record = 'Overall',
conf_record = 'Conf.',
adj_em = 'Adj. EM',
kp_adj_o = 'Adj. Off',
kp_adj_d = 'Adj. Def',
pts_for = 'PF',
pts_against = 'PA',
diff = 'PD',
opp_logo = 'Next',
results = 'Form'
)
return(table)
}
table <- plot_pl_standings('Amer', 'aac', 'American')
gtsave_extra(table, 'amer_pl_table.png', zoom = 5)
crop_gt('amer_pl_table.png', 60)
library(cbbdata)
library(tidyverse)
library(gt)
library(gtExtras)
library(glue)
library(magick)
library(rvest)
library(xml2)
library(httr2)
gt_theme_pl <- function(gt_object, ...) {
table_id <- subset(gt_object[['_options']], parameter == 'table_id')$value[[1]]
if (is.na(table_id)) {
table_id <- gt::random_id()
opt_position <- which("table_id" %in% gt_object[["_options"]][["parameter"]])[[1]]
gt_object[["_options"]][["value"]][[opt_position]] <- table_id
}
gt_object %>%
gt::tab_style(
locations = gt::cells_body(
columns = gt::everything()
),
style = gt::cell_text(
font = gt::google_font('DM Sans'),
color = '#37003c',
size = px(14)
)
) %>%
gt::tab_style(
locations = gt::cells_column_labels(
columns = gt::everything()
),
style = gt::cell_text(
font = gt::google_font('DM Sans'),
color = '#87668a',
weight = 650,
size = px(12),
transform = 'capitalize'
)
) %>%
gt::tab_style(
locations = gt::cells_title('title'),
style = gt::cell_text(
font = gt::google_font('DM Sans'),
weight = 650
)
) %>%
gt::tab_style(
locations = gt::cells_title('subtitle'),
style = gt::cell_text(
font = gt::google_font('DM Sans'),
weight = 500
)
) %>%
gt::tab_style(
locations = gt::cells_source_notes(),
style = gt::cell_text(
font = gt::google_font('DM Sans'),
)
) %>%
gt::tab_options(
heading.align = "left",
column_labels.border.top.style = "none",
table.border.top.style = "none",
table_body.border.top.style = "none",
table_body.border.bottom.color = "white",
heading.border.bottom.style = "none",
data_row.padding = px(3),
column_labels.font.size = px(12),
table.border.bottom.style = "none",
source_notes.font.size = 10,
source_notes.border.lr.style = "none",
column_labels.border.bottom.style = "solid",
column_labels.border.bottom.width = px(1),
column_labels.border.bottom.color = "#37003c",
...
) %>%
gt::opt_css(
paste0("#", table_id,
" .gt_col_heading
{
padding-bottom: 3px;
}",
"#", table_id,
" .gt_heading
{
padding-bottom: 0px;
padding-top: 6px
}",
"#", table_id,
" .gt_subtitle
{
padding-top: 2px;
padding-bottom: 6px;
}",
"#", table_id,
" .gt_sourcenote
{
line-height: 1.2
}"),
add = TRUE
)
}
plot_pl_standings <- function(conf, nnet_conf, conf_label) {
nonet_current <- function(conf) {
nonet_game_results <- function(conf) {
url <- paste0('https://bball.notnothing.net/schedules/', conf, 'm.xml')
request(url) %>%
req_perform() %>%
resp_body_xml() %>%
xml_find_all(".//allgames") %>%
pluck(1) %>%
xml_find_all(".//game") %>%
#pluck(1) %>%
xml_attrs() %>%
map_dfr(., enframe) %>%
pivot_wider() %>%
unnest() %>%
janitor::clean_names() %>%
mutate(gid = paste0(home, '-', visitor, '-1'),
date = as.Date(date, format = '%Y%m%d'),
result = ifelse(complete == 'Y', ifelse(winner == 'H', 1, 0),
NA)) %>%
mutate(conf = conf) %>%
select(date, gid, result)
}
game_results <- suppressWarnings(nonet_game_results(conf))
to_submit <- game_results %>%
filter(!is.na(result))
md5 <- read_html(paste0("https://bball.notnothing.net/", conf, ".php?sport=mbb")) %>%
html_nodes("input[name='md5']") %>%
html_attr('value')
db <- paste0('schedules%2F', conf, 'm.xml')
fixed_data <- paste0('database=schedules%2F', conf, 'm.xml&isuwins=&verbose=&md5=', md5)
form_data <- to_submit %>%
mutate(gid_result = paste(gid, result, sep="=")) %>%
pull(gid_result) %>%
paste(collapse = "&")
full_post <- paste(form_data, fixed_data, sep="&")
post_nonet <- function(conf) {
team_ids <- cbd_teams() %>% select(tid = nnet_id, matched = common_team,
shortname = nnet_short)
request(paste0('https://bball.notnothing.net/bracket.php?conf=', conf, 'm')) %>%
req_body_raw(full_post, type = "application/x-www-form-urlencoded") %>%
req_perform() %>%
resp_body_html() %>%
html_text() %>%
str_squish() %>%
str_match_all(., "(\\d+)\\.\\s+([^\\(]+)\\s+\\(([^\\)]+)\\)") %>%
pluck(1) %>%
as_tibble() %>%
select(finish = V2, team = V3, record = V4) %>%
mutate(record = gsub(' - ', '-', record),
conf = conf) %>%
left_join(team_ids %>% select(shortname, matched),
join_by('team' == 'shortname')) %>%
select(finish, team = matched, record, conf)
}
data <- post_nonet(conf)
return(data)
}
seeds <- nonet_current(nnet_conf)
conf_data <- cbd_torvik_team_factors(year = 2024, game_type = 'conf') %>%
filter(conf == !!conf)
last_five <- cbd_torvik_game_box(year = 2024, conf = conf) %>%
slice_max(date, n = 5, by = team) %>%
arrange(date) %>%
select(team, result) %>%
mutate(result = ifelse(result == 'W', 1, 0)) %>%
summarize(
results = list(result),
.by = team
)
point_diff <- cbd_torvik_game_box(year = 2024, conf = conf) %>%
filter(type == 'conf') %>%
summarize(
pts_for = sum(pts),
pts_against = sum(opp_pts),
diff = pts_for - pts_against,
.by = team
)
next_opp <- cbd_torvik_team_schedule(year = 2024) %>%
filter(team %in% conf_data$team & date >= Sys.Date()) %>%
slice_min(date, n = 1, by = team) %>%
select(team, opp)
data <- conf_data %>%
left_join(cbd_kenpom_ratings(year=2024) %>% select(adj_em, kp_adj_o = adj_o, kp_adj_d = adj_d, team)) %>%
left_join(
cbd_torvik_game_box(year = 2024, conf = conf) %>%
summarize(ov_record = glue("{sum(result == 'W')}-{sum(result=='L')}"), .by = team)
) %>%
mutate(conf_record = glue('{wins}-{losses}')) %>%
select(team, ov_record, conf_record, adj_em, kp_adj_o, kp_adj_d, adj_em) %>%
left_join(point_diff, by = 'team') %>%
left_join(next_opp, by = 'team') %>%
inner_join(seeds %>% mutate(seed = as.numeric(finish), record = NULL, conf = NULL, finish = NULL), by = 'team') %>%
left_join(last_five, by = 'team') %>%
left_join(cbd_teams() %>% select(team = common_team, team_abbr = espn_abbreviation, logo), by = 'team') %>%
left_join(cbd_teams() %>% select(opp = common_team, opp_logo = logo), by = 'opp') %>%
mutate(opp_logo = ifelse(is.na(opp), 'https://static-00.iconduck.com/assets.00/hourglass-half-icon-1608x2048-ctcr2jce.png', opp_logo),
opp_logo = glue("<img src='{opp_logo}' style='height: 20px; width: auto; vertical-align: middle;'>"),
team = glue("<img src='{logo}' style='height: 20px; width: auto; vertical-align: -30%;'> &nbsp; {seed}. {team_abbr}")
) %>%
arrange(seed)
table <- data %>%
select(-c(team_abbr, logo, seed)) %>%
gt() %>%
cols_hide(opp) %>%
gt_theme_pl() %>%
gt_plt_winloss(results, max_wins = 5, palette = c('#637E6C', '#EF946C', 'white')) %>%
gt_add_divider(conf_record, include_labels = FALSE, weight = px(1), color = '#37003c') %>%
gt_add_divider(kp_adj_d, include_labels = FALSE, weight = px(1), color = '#37003c') %>%
tab_style(locations = cells_body(rows = c(4, 6, 10)), style = cell_borders(sides = 'bottom', color = '#37003c')) %>%
fmt_markdown(c(team, opp_logo)) %>%
fmt_number(pts_for:diff, decimals = 0) %>%
cols_align(column = team, 'left') %>%
cols_align(column = -team, 'center') %>%
tab_spanner(columns = contains('record'), label = 'Records') %>%
tab_spanner(columns = adj_em:kp_adj_d, label = 'KenPom Efficiencies') %>%
tab_style(locations = cells_body(columns = team), cell_text(weight = 'bold')) %>%
tab_header(glue("{conf_label} Men's Basketball Table | End of Regular Season"),
"Data current through the end of the regular season w/ an EPL table spin") %>%
tab_source_note(md('Data by cbbdata + cbbplotR through March 11<br>Table by @andreweatherman')) %>%
cols_label(
team = 'Team + Seed',
ov_record = 'Overall',
conf_record = 'Conf.',
adj_em = 'Adj. EM',
kp_adj_o = 'Adj. Off',
kp_adj_d = 'Adj. Def',
pts_for = 'PF',
pts_against = 'PA',
diff = 'PD',
opp_logo = 'Next',
results = 'Form'
)
return(table)
}
table <- plot_pl_standings('Amer', 'aac', 'American')
gtsave_extra(table, 'amer_pl_table.png', zoom = 5)
crop_gt('amer_pl_table.png', 60)
crop_gt <- function(file, whitespace) {
image_read(file) %>%
image_trim() %>%
image_border("white", glue('{whitespace}x{whitespace}')) %>%
image_write(file)
}
crop_gt('amer_pl_table.png', 60)
cbd_torvik_game_box(year = 2024, conf = conf) %>%
filter(type == 'conf')
696/1295
33/40
gt_theme_538
